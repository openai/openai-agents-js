---
title: MCP 連携
description: Learn how to utilize MCP servers as tools
---

import { Code } from '@astrojs/starlight/components';
import hostedAgentExample from '../../../../../../examples/docs/mcp/hostedAgent.ts?raw';
import hostedExample from '../../../../../../examples/docs/mcp/hosted.ts?raw';
import hostedStreamExample from '../../../../../../examples/docs/mcp/hostedStream.ts?raw';
import hostedHITLExample from '../../../../../../examples/docs/mcp/hostedHITL.ts?raw';
import hostedConnectorExample from '../../../../../../examples/docs/mcp/hostedConnector.ts?raw';
import streamableHttpExample from '../../../../../../examples/docs/mcp/streamableHttp.ts?raw';
import stdioExample from '../../../../../../examples/docs/mcp/stdio.ts?raw';
import toolFilterExample from '../../../../../../examples/docs/mcp/tool-filter.ts?raw';

[**Model Context Protocol (MCP)**](https://modelcontextprotocol.io) は、アプリケーションが LLMs にツールとコンテキストを提供する方法を標準化するオープンなプロトコルです。MCP ドキュメントより引用:

> MCP は、アプリケーションが LLMs にコンテキストを提供する方法を標準化するオープンプロトコルです。MCP を AI アプリケーション向けの USB‑C ポートと考えてください。USB‑C がさまざまな周辺機器やアクセサリにデバイスを接続するための標準化された方法を提供するのと同様に、MCP は AI モデルを異なるデータソースやツールに接続する標準化された方法を提供します。

この SDK がサポートする MCP サーバーには 3 つのタイプがあります:

1. **リモート MCP サーバーツール** – [OpenAI Responses API](https://platform.openai.com/docs/guides/tools-remote-mcp) がツールとして利用するリモート MCP サーバー
2. **Streamable HTTP MCP サーバー** – [Streamable HTTP トランスポート](https://modelcontextprotocol.io/docs/concepts/transports#streamable-http) を実装したローカルまたはリモートのサーバー
3. **Stdio MCP サーバー** – 標準入出力経由でアクセスされるサーバー（最もシンプルな選択肢）

> 注: この SDK にはレガシーの Server‑Sent Events トランスポート向けに `MCPServerSSE` も含まれますが、SSE は MCP プロジェクトによって非推奨になりました。新しい連携では Streamable HTTP または stdio を推奨します。

ユースケースに基づいてサーバータイプを選択してください:

| 必要なこと                                                               | 推奨オプション             |
| ------------------------------------------------------------------------ | -------------------------- |
| 公開アクセス可能なリモートサーバーを既定の OpenAI Responses モデルで呼ぶ | **1. リモート MCP ツール** |
| 公開アクセス可能なリモートサーバーを使いつつツール呼び出しはローカルで   | **2. Streamable HTTP**     |
| ローカルで稼働する Streamable HTTP サーバーを使う                        | **2. Streamable HTTP**     |
| OpenAI Responses 以外のモデルで任意の Streamable HTTP サーバーを使う     | **2. Streamable HTTP**     |
| 標準入出力プロトコルのみ対応のローカル MCP サーバーと連携する            | **3. Stdio**               |

## 1. リモート MCP サーバーツール

組み込みツール（Hosted）は、往復処理全体をモデル内に押し込みます。あなたのコードが MCP サーバーを呼び出すのではなく、OpenAI Responses API がリモートのツールエンドポイントを呼び出し、その結果をモデルへストリーミングします。

以下は Hosted MCP ツールを使う最も簡単な例です。リモート MCP サーバーのラベルと URL を `hostedMcpTool` ユーティリティ関数に渡すことで、Hosted MCP サーバーツールを簡単に作成できます。

<Code lang="typescript" code={hostedAgentExample} title="hostedAgent.ts" />

その後、`run` 関数（またはカスタマイズした `Runner` インスタンスの `run` メソッド）でエージェントを実行できます:

<Code lang="typescript" code={hostedExample} title="Hosted MCP ツールで実行" />

MCP の増分結果をストリーミングするには、`Agent` を実行するときに `stream: true` を渡します:

<Code
  lang="typescript"
  code={hostedStreamExample}
  title="Hosted MCP ツールで実行（ストリーミング）"
/>

#### 任意の承認フロー

機微な操作については、個々のツール呼び出しに人による承認を必須にできます。`requireApproval: 'always'` もしくは、ツール名から `'never'` / `'always'` への詳細なマッピングオブジェクトを渡してください。

ツール呼び出しが安全かどうかをプログラムで判定できる場合は、[`onApproval` コールバック](https://github.com/openai/openai-agents-js/blob/main/examples/mcp/hosted-mcp-on-approval.ts) を使って承認または却下できます。人による承認が必要な場合は、ローカルの 関数ツール と同様に `interruptions` を使った同じ [人間の介入（HITL）](/openai-agents-js/ja/guides/human-in-the-loop/) アプローチを利用できます。

<Code
  lang="typescript"
  code={hostedHITLExample}
  title="Hosted MCP ツールでの Human in the loop"
/>

### コネクタ対応の Hosted サーバー

Hosted MCP は OpenAI コネクタにも対応しています。`serverUrl` を提供する代わりに、コネクタの `connectorId` と `authorization` トークンを渡します。Responses API が認証を処理し、Hosted MCP インターフェースを通じてコネクタのツールを公開します。

<Code
  lang="typescript"
  code={hostedConnectorExample}
  title="コネクタ対応の Hosted MCP ツール"
/>

この例では、環境変数 `GOOGLE_CALENDAR_AUTHORIZATION` に Google OAuth Playground から取得した OAuth トークンが格納されており、コネクタ対応サーバーが Calendar API を呼び出すことを許可します。ストリーミングも示す実行可能なサンプルは [`examples/connectors`](https://github.com/openai/openai-agents-js/tree/main/examples/connectors) を参照してください。

完全に動作するサンプル（Hosted ツール/Streamable HTTP/stdio + ストリーミング、HITL、onApproval）は、GitHub リポジトリの [examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp) にあります。

## 2. Streamable HTTP MCP サーバー

エージェントがローカルまたはリモートの Streamable HTTP MCP サーバーと直接通信する場合は、サーバーの `url`、`name`、任意設定を指定して `MCPServerStreamableHttp` を初期化します:

<Code
  lang="typescript"
  code={streamableHttpExample}
  title="Streamable HTTP MCP サーバーで実行"
/>

コンストラクターのオプション:

| オプション                    | 型                                             | 備考                                       |
| ----------------------------- | ---------------------------------------------- | ------------------------------------------ |
| `url`                         | `string`                                       | Streamable HTTP サーバーの URL             |
| `name`                        | `string`                                       | サーバーの任意ラベル                       |
| `cacheToolsList`              | `boolean`                                      | ツール一覧をキャッシュしてレイテンシを削減 |
| `clientSessionTimeoutSeconds` | `number`                                       | MCP クライアントセッションのタイムアウト   |
| `toolFilter`                  | `MCPToolFilterCallable \| MCPToolFilterStatic` | 利用可能なツールのフィルター               |
| `timeout`                     | `number`                                       | リクエストごとのタイムアウト（ミリ秒）     |
| `logger`                      | `Logger`                                       | カスタムロガー                             |
| `authProvider`                | `OAuthClientProvider`                          | MCP TypeScript SDK の OAuth プロバイダー   |
| `requestInit`                 | `RequestInit`                                  | リクエストの fetch 初期化オプション        |
| `fetch`                       | `FetchLike`                                    | カスタム fetch 実装                        |
| `reconnectionOptions`         | `StreamableHTTPReconnectionOptions`            | 再接続の調整オプション                     |
| `sessionId`                   | `string`                                       | MCP 接続用の明示的なセッション ID          |

コンストラクターは、`authProvider`、`requestInit`、`fetch`、`reconnectionOptions`、`sessionId` など MCP TypeScript SDK の追加オプションも受け付けます。詳細は [MCP TypeScript SDK リポジトリ](https://github.com/modelcontextprotocol/typescript-sdk) とそのドキュメントを参照してください。

## 3. Stdio MCP サーバー

標準入出力のみを公開するサーバーには、`fullCommand` を指定して `MCPServerStdio` を初期化します:

<Code lang="typescript" code={stdioExample} title="Stdio MCP サーバーで実行" />

コンストラクターのオプション:

| オプション                    | 型                                             | 備考                                              |
| ----------------------------- | ---------------------------------------------- | ------------------------------------------------- |
| `command` / `args`            | `string` / `string[]`                          | stdio サーバー用のコマンドと引数                  |
| `fullCommand`                 | `string`                                       | `command` + `args` の代替となるフルコマンド文字列 |
| `env`                         | `Record<string, string>`                       | サーバープロセス用の環境変数                      |
| `cwd`                         | `string`                                       | サーバープロセスの作業ディレクトリ                |
| `cacheToolsList`              | `boolean`                                      | ツール一覧をキャッシュしてレイテンシを削減        |
| `clientSessionTimeoutSeconds` | `number`                                       | MCP クライアントセッションのタイムアウト          |
| `name`                        | `string`                                       | サーバーの任意ラベル                              |
| `encoding`                    | `string`                                       | stdio ストリームのエンコーディング                |
| `encodingErrorHandler`        | `'strict' \| 'ignore' \| 'replace'`            | エンコーディングエラー時の戦略                    |
| `toolFilter`                  | `MCPToolFilterCallable \| MCPToolFilterStatic` | 利用可能なツールのフィルター                      |
| `timeout`                     | `number`                                       | リクエストごとのタイムアウト（ミリ秒）            |
| `logger`                      | `Logger`                                       | カスタムロガー                                    |

## 知っておくとよいこと

**Streamable HTTP** と **Stdio** サーバーでは、`Agent` の各実行時に利用可能なツールを検出するため `list_tools()` を呼び出すことがあります。この往復はレイテンシを増やす可能性があり（特にリモートサーバーで）、`MCPServerStdio` または `MCPServerStreamableHttp` に `cacheToolsList: true` を渡すことでメモリ内に結果をキャッシュできます。

ツール一覧が変わらないと確信できる場合にのみ有効化してください。後でキャッシュを無効化するには、サーバーインスタンスの `invalidateToolsCache()` を呼び出します。

### ツールのフィルタリング

`createMCPToolStaticFilter` による静的フィルター、またはカスタム関数を渡して、各サーバーから公開されるツールを制限できます。以下は両方のアプローチを示す統合例です:

<Code
  lang="typescript"
  code={toolFilterExample}
  title="ツールのフィルタリング"
/>

## 参考資料

- [Model Context Protocol](https://modelcontextprotocol.io/) – 公式仕様
- [examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp) – 上記の実行可能デモ
