---
title: MCP 連携
description: Learn how to utilize MCP servers as tools
---

import { Code } from '@astrojs/starlight/components';
import hostedAgentExample from '../../../../../../examples/docs/mcp/hostedAgent.ts?raw';
import hostedExample from '../../../../../../examples/docs/mcp/hosted.ts?raw';
import hostedStreamExample from '../../../../../../examples/docs/mcp/hostedStream.ts?raw';
import hostedHITLExample from '../../../../../../examples/docs/mcp/hostedHITL.ts?raw';
import streamableHttpExample from '../../../../../../examples/docs/mcp/streamableHttp.ts?raw';
import stdioExample from '../../../../../../examples/docs/mcp/stdio.ts?raw';
import toolFilterExample from '../../../../../../examples/docs/mcp/tool-filter.ts?raw';

[**Model Context Protocol (MCP)**](https://modelcontextprotocol.io) は、アプリケーションが LLM にツールやコンテキストを提供する方法を標準化するオープンなプロトコルです。MCP のドキュメントより：

> MCP は、アプリケーションが LLM にコンテキストを提供する方法を標準化するオープンなプロトコルです。MCP は AI アプリケーション向けの USB‑C ポートのようなものだと考えてください。USB‑C がデバイスをさまざまな周辺機器やアクセサリに接続する標準化された方法を提供するのと同様に、MCP は AI モデルをさまざまなデータソースやツールに接続する標準化された方法を提供します。

この SDK がサポートする MCP サーバーは 3 種類あります：

1. **リモート MCP サーバーツール** – [OpenAI Responses API](https://platform.openai.com/docs/guides/tools-remote-mcp) によってツールとして利用されるリモート MCP サーバー
2. **Streamable HTTP MCP サーバー** – [Streamable HTTP トランスポート](https://modelcontextprotocol.io/docs/concepts/transports#streamable-http) を実装するローカルまたはリモートのサーバー
3. **Stdio MCP サーバー** – 標準入出力でアクセスされるサーバー（最も簡単な選択肢）

ユースケースに応じてサーバータイプを選択してください：

| 必要なこと                                                                 | 推奨オプション          |
| -------------------------------------------------------------------------- | ----------------------- |
| 一般公開のリモートサーバーを既定の OpenAI Responses モデルで呼び出す       | **1. Hosted MCP tools** |
| 一般公開のリモートサーバーを使うがツール呼び出しはローカルでトリガーしたい | **2. Streamable HTTP**  |
| ローカルで動作する Streamable HTTP サーバーを使う                          | **2. Streamable HTTP**  |
| OpenAI Responses 以外のモデルで任意の Streamable HTTP サーバーを使う       | **2. Streamable HTTP**  |
| 標準入出力プロトコルのみをサポートするローカル MCP サーバーを扱う          | **3. Stdio**            |

## 1. リモート MCP サーバーツール

リモート ツールでは、往復の処理全体をモデル側で完結させます。あなたのコードが MCP サーバーを呼び出す代わりに、OpenAI Responses API がリモートのツールエンドポイントを呼び出し、その結果をモデルへストリーミングで返します。

以下はリモート MCP サーバーツールを使う最も簡単な例です。`hostedMcpTool` ユーティリティ関数にリモート MCP サーバーのラベルと URL を渡すことで、リモート MCP サーバーツールの作成に便利です。

<Code lang="typescript" code={hostedAgentExample} title="hostedAgent.ts" />

次に、`run` 関数（またはカスタマイズした `Runner` インスタンスの `run` メソッド）で エージェント を実行できます：

<Code
  lang="typescript"
  code={hostedExample}
  title="リモート MCP サーバーツールで実行"
/>

増分の MCP 結果を ストリーミング するには、`Agent` を実行するときに `stream: true` を渡します：

<Code
  lang="typescript"
  code={hostedStreamExample}
  title="リモート MCP サーバーツールで実行（ストリーミング）"
/>

#### 承認フロー（オプション）

センシティブな操作については、個々のツール呼び出しに人間による承認を要求できます。`requireApproval: 'always'` を渡すか、ツール名を `'never'`/`'always'` にマッピングするきめ細かなオブジェクトを渡してください。

プログラムでツール呼び出しの安全性を判定できる場合は、[`onApproval` コールバック](https://github.com/openai/openai-agents-js/blob/main/examples/mcp/hosted-mcp-on-approval.ts) を使って承認または却下できます。人による承認が必要な場合は、ローカルの 関数ツール と同様に `interruptions` を使った同じ [人間の介入（HITL）](/openai-agents-js/ja/guides/human-in-the-loop/) のアプローチを使えます。

<Code
  lang="typescript"
  code={hostedHITLExample}
  title="リモート MCP ツールでの Human in the loop (人間の介入)"
/>

完全に動作するサンプル（Hosted tools / Streamable HTTP / stdio + Streaming、HITL、onApproval）は、GitHub リポジトリの [examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp) にあります。

## 2. Streamable HTTP MCP サーバー

エージェント がローカルまたはリモートの Streamable HTTP MCP サーバーと直接対話する場合は、サーバーの `url`、`name`、および任意の設定を指定して `MCPServerStreamableHttp` をインスタンス化します：

<Code
  lang="typescript"
  code={streamableHttpExample}
  title="Streamable HTTP MCP サーバーで実行"
/>

コンストラクターは、`authProvider`、`requestInit`、`fetch`、`reconnectionOptions`、`sessionId` などの追加の MCP TypeScript SDK オプションも受け付けます。詳細は [MCP TypeScript SDK リポジトリ](https://github.com/modelcontextprotocol/typescript-sdk) とそのドキュメントを参照してください。

## 3. Stdio MCP サーバー

標準入出力のみを公開するサーバーの場合は、`fullCommand` を指定して `MCPServerStdio` をインスタンス化します：

<Code lang="typescript" code={stdioExample} title="Stdio MCP サーバーで実行" />

## 知っておくとよいこと

Streamable HTTP と Stdio のサーバーでは、`Agent` が実行されるたびに、利用可能なツールを見つけるために `list_tools()` を呼び出すことがあります。この往復はレイテンシを追加する可能性があり（特にリモートサーバーに対して）、`MCPServerStdio` または `MCPServerStreamableHttp` に `cacheToolsList: true` を渡してメモリ内に結果をキャッシュできます。

ツールリストが変わらない自信がある場合にのみ有効化してください。後からキャッシュを無効化するには、サーバーインスタンスで `invalidateToolsCache()` を呼び出します。

### ツールのフィルタリング

各サーバーから公開するツールを制限するには、`createMCPToolStaticFilter` による静的フィルター、またはカスタム関数を渡します。両方のアプローチを示す統合例を次に示します：

<Code
  lang="typescript"
  code={toolFilterExample}
  title="ツールのフィルタリング"
/>

## 参考資料

- [Model Context Protocol](https://modelcontextprotocol.io/) – 公式仕様
- [examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp) – 上記で参照した実行可能なデモ
