---
title: 人間の介入（HITL）
description: Add a human in the loop check for your agent executions
---

import { Aside, Code } from '@astrojs/starlight/components';
import humanInTheLoopExample from '../../../../../../examples/docs/human-in-the-loop/index.ts?raw';
import toolApprovalDefinition from '../../../../../../examples/docs/human-in-the-loop/toolApprovalDefinition.ts?raw';

このガイドでは、 SDK に組み込まれた Human in the loop (人間の介入) サポートを使用して、人による介入に基づいてエージェントの実行を一時停止および再開する方法を紹介します。

現時点での主なユースケースは、機微なツール実行について承認を求めることです。

## 承認リクエスト

承認が必要なツールは、`needsApproval` オプションを `true` に設定するか、真偽値を返す非同期関数を指定して定義できます。

<Code
  lang="typescript"
  code={toolApprovalDefinition}
  title="ツール承認の定義"
  meta={`{10}`}
/>

### フロー

1. エージェントが 1 つ以上のツール呼び出しを決定した場合、`needsApproval` を評価してそのツールに承認が必要かどうかを確認します。
2. 承認が必要な場合、エージェントは承認がすでに許可または却下されているかを確認します。
   - 承認がまだ許可も却下もされていない場合、ツールはツール呼び出しを実行できないことを示す固定メッセージをエージェントに返します。
   - 承認／却下が未決の場合は、ツール承認リクエストがトリガーされます。
3. エージェントはすべてのツール承認リクエストを収集し、実行を中断します。
4. 中断がある場合、[エージェントの実行結果](/openai-agents-js/ja/guides/result) には、保留中のステップを説明する `interruptions` 配列が含まれます。ツール呼び出しに確認が必要なときは、`type: "tool_approval_item"` を持つ `ToolApprovalItem` が現れます。
5. ツール呼び出しを承認または拒否するには、`result.state.approve(interruption)` または `result.state.reject(interruption)` を呼び出せます。
6. すべての中断を処理した後、`result.state` を `runner.run(agent, state)` に渡し直すことで実行を再開できます。ここで `agent` は全体の実行を開始した元のエージェントです。
7. フローは手順 1 から再開します。

## 例

以下は、ターミナルで承認を促し、状態を一時的にファイルへ保存する Human in the loop (人間の介入) フローの、より完全な例です。

<Code
  lang="typescript"
  code={humanInTheLoopExample}
  title="Human in the loop (人間の介入)"
/>

動作するエンドツーエンド版については [完全なサンプルスクリプト](https://github.com/openai/openai-agents-js/tree/main/examples/agent-patterns/human-in-the-loop.ts) を参照してください。

## 長い承認待ち時間への対応

Human in the loop (人間の介入) フローは、サーバーを起動し続けなくても長時間中断できるように設計されています。リクエストをいったん終了して後で続行する必要がある場合は、状態をシリアライズして後から再開できます。

状態は `JSON.stringify(result.state)` を使ってシリアライズでき、後でシリアライズ済み状態を `RunState.fromString(agent, serializedState)` に渡すことで再開できます。ここで `agent` は全体の実行を開始したエージェントのインスタンスです。

この方法なら、シリアライズした状態をデータベースやリクエストと一緒に保存できます。

### 保留タスクのバージョニング

<Aside>
  これは主に、エージェントに変更を加えながら、シリアライズした状態を長期間保存しようとしている場合に該当します。
</Aside>

承認リクエストに時間がかかり、エージェント定義に意味のあるバージョニングを行いたい、または Agents SDK のバージョンを上げたい場合は、現在のところ、パッケージエイリアスを使って 2 つの Agents SDK のバージョンを並行インストールし、独自のブランチングロジックを実装することを推奨します。

実務上は、独自コードにバージョン番号を付与してシリアライズ済みの状態と一緒に保存し、復元時に自分のコードの正しいバージョンへ誘導することを意味します。
