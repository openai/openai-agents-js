---
title: 人間の介入（HITL）
description: Add a human in the loop check for your agent executions
---

import { Aside, Code } from '@astrojs/starlight/components';
import humanInTheLoopExample from '../../../../../../examples/docs/human-in-the-loop/index.ts?raw';
import toolApprovalDefinition from '../../../../../../examples/docs/human-in-the-loop/toolApprovalDefinition.ts?raw';

このガイドでは、SDK に組み込まれた Human in the loop (人間の介入) サポートを使い、人による介入に基づいて エージェント の実行を一時停止・再開する方法を説明します。

現時点での主なユースケースは、機微な ツール 実行の承認を求めることです。

## 承認リクエスト

承認が必要な ツール は、`needsApproval` オプションを `true`、または boolean を返す非同期関数に設定して定義できます。

<Code
  lang="typescript"
  code={toolApprovalDefinition}
  title="ツールの承認定義"
  meta={`{10}`}
/>

### フロー

1. エージェント が 1 つ以上の ツール 呼び出しを決定した場合、`needsApproval` の評価によりその ツール に承認が必要か確認します
2. 承認が必要な場合、すでに承認または拒否されているかを確認します
   - 未承認・未拒否の場合、ツールは「ツール呼び出しを実行できない」という静的メッセージを エージェント に返します
   - 承認 / 拒否が未処理であれば、ツールの承認リクエストがトリガーされます
3. エージェント はすべてのツール承認リクエストを収集し、実行を中断します
4. 中断がある場合、[エージェントの実行結果](/openai-agents-js/ja/guides/results) に、保留中のステップを表す `interruptions` 配列が含まれます。ツール呼び出しに確認が必要なときは、`type: "tool_approval_item"` を持つ `ToolApprovalItem` が現れます
5. ツール呼び出しの承認または拒否には、`result.state.approve(interruption)` または `result.state.reject(interruption)` を呼び出します
6. すべての中断を処理したら、`result.state` を `runner.run(agent, state)` に渡して実行を再開します。`agent` は全体の実行を開始した元の エージェント です
7. フローはステップ 1 から再開されます

## 例

以下は、ターミナルで承認を促し、状態を一時的にファイルに保存する Human in the loop のより完全なフロー例です。

<Code
  lang="typescript"
  code={humanInTheLoopExample}
  title="Human in the loop (人間の介入)"
/>

エンドツーエンドで動作する版は [完全なサンプルスクリプト](https://github.com/openai/openai-agents-js/tree/main/examples/agent-patterns/human-in-the-loop.ts) を参照してください。

## 長時間の承認待ちへの対応

Human in the loop のフローは、サーバー を起動し続けることなく長時間中断できるよう設計されています。リクエストをいったん終了し、後で再開する必要がある場合は、状態をシリアライズして後から再開できます。

状態は `JSON.stringify(result.state)` でシリアライズでき、後で `RunState.fromString(agent, serializedState)` にシリアライズ済みの状態を渡すことで再開できます。ここで `agent` は全体の実行を開始した エージェント のインスタンスです。

この方法なら、シリアライズした状態を データベース、またはリクエストと一緒に保存できます。

### 保留タスクのバージョニング

<Aside>
  これは主に、エージェント
  に変更を加えつつ、シリアライズした状態を長期間保存しようとしている場合に当てはまります。
</Aside>

承認リクエストに時間がかかり、エージェント定義に意味のある形でバージョンを付けたい場合や、Agents SDK のバージョンを上げたい場合は、現在のところ、パッケージエイリアス（package aliases）を用いて 2 つの Agents SDK バージョンを並行インストールし、独自のブランチングロジックを実装することをおすすめします。

実務上は、独自コードにバージョン番号を割り当て、それをシリアライズした状態とともに保存し、逆シリアライズを正しいコードバージョンに誘導することを意味します。
