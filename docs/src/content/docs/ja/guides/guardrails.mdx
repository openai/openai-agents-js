---
title: ガードレール
description: Validate or transform agent input and output
---

import { Code } from '@astrojs/starlight/components';
import inputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-input.ts?raw';
import outputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-output.ts?raw';

ガードレールはエージェントと並行して実行することも、完了まで実行をブロックすることもでき、ユーザー入力やエージェント出力に対してチェックやバリデーションを実行できます。たとえば、コストの高いモデルを呼び出す前に軽量なモデルをガードレールとして実行できます。ガードレールが不正な使用を検出した場合は、エラーを発生させて高コストなモデルの実行を停止できます。

ガードレールには 2 つの種類があります:

1. **Input guardrails** は最初のユーザー入力に対して実行されます
2. **Output guardrails** は最終的なエージェント出力に対して実行されます

## Input guardrails

Input guardrails は次の 3 つの手順で実行されます:

1. ガードレールはエージェントに渡されるものと同じ入力を受け取ります
2. ガードレール関数が実行され、[`InputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/inputguardrailresult) 内にラップされた [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput) を返します
3. `tripwireTriggered` が `true` の場合、[`InputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/inputguardrailtripwiretriggered) エラーがスローされます

> **Note**
> Input guardrails はユーザー入力を対象としているため、ワークフローでそのエージェントが最初のエージェントである場合にのみ実行されます。ガードレールはエージェント自体に設定します。なぜならエージェントごとに必要なガードレールが異なることが多いためです。

### 実行モード

- `runInParallel: true`（デフォルト）は、LLM/ツール呼び出しと並行してガードレールを開始します。これにより待ち時間は最小化されますが、後からガードレールがトリガーされた場合、モデルはすでにトークンを消費したりツールを実行している可能性があります
- `runInParallel: false` はモデルを呼び出す前にガードレールを実行し、ガードレールがリクエストをブロックする際のトークン消費やツール実行を防ぎます。待ち時間よりも安全性やコストを優先したい場合に使用します

## Output guardrails

Output guardrails は次の 3 つの手順で実行されます:

1. ガードレールはエージェントが生成した出力を受け取ります
2. ガードレール関数が実行され、[`OutputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/outputguardrailresult) 内にラップされた [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput) を返します
3. `tripwireTriggered` が `true` の場合、[`OutputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/outputguardrailtripwiretriggered) エラーがスローされます

> **Note**
> Output guardrails は、そのエージェントがワークフローの最後のエージェントである場合にのみ実行されます。リアルタイム音声での対話については[音声エージェントの構築](/openai-agents-js/guides/voice-agents/build#guardrails)を参照してください。

## トリップワイヤー

ガードレールが失敗すると、トリップワイヤーを介してそれを知らせます。トリップワイヤーがトリガーされるとすぐに、ランナーは対応するエラーをスローし、実行を停止します。

## ガードレールの実装

ガードレールは `GuardrailFunctionOutput` を返す関数にすぎません。以下は、内部で別のエージェントを実行してユーザーが数学の宿題の手助けを求めているかどうかを確認する最小の例です。

<Code
  lang="typescript"
  code={inputGuardrailExample}
  title="Input guardrail の例"
/>

Output guardrails も同様に動作します。

<Code
  lang="typescript"
  code={outputGuardrailExample}
  title="Output guardrail の例"
/>

1. `guardrailAgent` はガードレール関数内で使用されます
2. ガードレール関数はエージェントの入力または出力を受け取り、結果を返します
3. 追加情報をガードレール結果に含めることができます
4. `agent` はガードレールが適用される実際のワークフローを定義します
