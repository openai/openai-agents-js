---
title: ガードレール
description: Validate or transform agent input and output
---

import { Code } from '@astrojs/starlight/components';
import inputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-input.ts?raw';
import outputGuardrailExample from '../../../../../../examples/docs/guardrails/guardrails-output.ts?raw';
import toolGuardrailsExample from '../../../../../../examples/docs/guardrails/toolGuardrails.ts?raw';

ガードレールは エージェント と並行して実行したり、完了まで実行をブロックしたりでき、ユーザー入力や エージェント 出力に対するチェックや検証を行えます。たとえば、高価な モデル を呼び出す前に軽量な モデル をガードレールとして実行できます。ガードレールが悪意ある利用を検知した場合は、エラーを発生させて高コストな モデル の実行を停止できます。

ガードレールには 2 種類あります:

1. **Input guardrails** は最初のユーザー入力に対して実行されます
2. **Output guardrails** は最終的な エージェント の出力に対して実行されます

## 入力ガードレール

入力ガードレールは 3 つのステップで実行されます:

1. ガードレールは エージェント に渡されたものと同じ入力を受け取ります
2. ガードレール関数が実行され、[`InputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/inputguardrailresult) 内にラップされた [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput) を返します
3. `tripwireTriggered` が `true` の場合、[`InputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/inputguardrailtripwiretriggered) エラーがスローされます

> **Note**
> 入力ガードレールはユーザー入力向けであり、ワークフローで エージェント が*最初*の場合にのみ実行されます。ガードレールは エージェント 自体に設定します。これは エージェント ごとに必要なガードレールが異なることが多いためです。

### 実行モード

- `runInParallel: true`（デフォルト）は、LLM/ツール呼び出しと並行してガードレールを開始します。レイテンシを最小化しますが、後からガードレールがトリガーされた場合でも、モデルがすでにトークンを消費したりツールを実行している可能性があります
- `runInParallel: false` は、モデルを呼び出す**前に**ガードレールを実行し、ガードレールがリクエストをブロックする場合にトークン消費やツール実行を防ぎます。レイテンシよりも安全性とコストを優先する場合に使用します

## 出力ガードレール

出力ガードレールは 3 つのステップで実行されます:

1. ガードレールは エージェント によって生成された出力を受け取ります
2. ガードレール関数が実行され、[`OutputGuardrailResult`](/openai-agents-js/openai/agents/interfaces/outputguardrailresult) 内にラップされた [`GuardrailFunctionOutput`](/openai-agents-js/openai/agents/interfaces/guardrailfunctionoutput) を返します
3. `tripwireTriggered` が `true` の場合、[`OutputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents/classes/outputguardrailtripwiretriggered) エラーがスローされます

> **Note**
> 出力ガードレールは、ワークフローで エージェント が*最後*の場合にのみ実行されます。リアルタイムの音声インタラクションについては[音声エージェントの構築](/openai-agents-js/ja/guides/voice-agents/build#guardrails)を参照してください。

## ツール用ガードレール

ツール用ガードレールは**関数ツール**をラップし、実行の前後でツール呼び出しを検証またはブロックできます。これらはツール自体（`tool()` のオプション）に設定され、すべてのツール呼び出しで実行されます。

- **入力ツールガードレール**はツールの実行前に動作し、メッセージで呼び出しを拒否したり、トリップワイヤーをスローできます
- **出力ツールガードレール**はツールの実行後に動作し、出力を拒否メッセージに置き換えたり、トリップワイヤーをスローできます

ツール用ガードレールは `behavior` を返します:

- `allow` — 次のガードレールまたはツールの実行に進む
- `rejectContent` — メッセージでショートサーキットする（ツール呼び出しをスキップ、または出力を置き換える）
- `throwException` — 直ちにトリップワイヤーエラーをスローする

ツール用ガードレールは `tool()` で作成した関数ツールに適用されます。組み込みツール（Hosted）やローカルのビルトインツール（`computerTool`、`shellTool`、`applyPatchTool`）はこのガードレールパイプラインを使用しません。

## トリップワイヤー

ガードレールが失敗すると、トリップワイヤーでそれを通知します。トリップワイヤーがトリガーされるとすぐに、ランナーは対応するエラーをスローし、実行を停止します。

## ガードレールの実装

ガードレールは、`GuardrailFunctionOutput` を返す関数にすぎません。以下は、内部で別の エージェント を実行して、ユーザーが数学の宿題の手伝いを求めているかどうかを確認する最小の例です。

<Code
  lang="typescript"
  code={inputGuardrailExample}
  title="入力ガードレールの例"
/>

出力ガードレールも同様に動作します。

<Code
  lang="typescript"
  code={outputGuardrailExample}
  title="出力ガードレールの例"
/>

ツールの入出力ガードレールは次のようになります:

<Code
  lang="typescript"
  code={toolGuardrailsExample}
  title="ツール用ガードレール"
/>

1. `guardrailAgent` はガードレール関数内で使用されます
2. ガードレール関数は エージェント の入力または出力を受け取り、結果を返します
3. 追加情報をガードレール結果に含めることができます
4. `agent` はガードレールが適用される実際のワークフローを定義します
