---
title: エージェントの実行
description: Configure and execute agent workflows with the Runner class
---

import { Aside, Code } from '@astrojs/starlight/components';
import helloWorldWithRunnerExample from '../../../../../../examples/docs/hello-world-with-runner.ts?raw';
import helloWorldExample from '../../../../../../examples/docs/hello-world.ts?raw';
import runningAgentsExceptionExample from '../../../../../../examples/docs/running-agents/exceptions1.ts?raw';
import chatLoopExample from '../../../../../../examples/docs/running-agents/chatLoop.ts?raw';
import conversationIdExample from '../../../../../../examples/docs/running-agents/conversationId.ts?raw';
import previousResponseIdExample from '../../../../../../examples/docs/running-agents/previousResponseId.ts?raw';

エージェントはそれ自体では何もしません。`Runner` クラスまたは `run()` ユーティリティでそれらを実行します。

<Code lang="typescript" code={helloWorldExample} title="シンプルな実行" />

カスタム Runner が不要な場合は、シングルトンのデフォルト `Runner` インスタンスで実行する `run()` ユーティリティも使えます。

別の方法として、独自の Runner インスタンスを作成できます:

<Code
  lang="typescript"
  code={helloWorldWithRunnerExample}
  title="シンプルな実行"
/>

エージェントの実行後、最終出力と実行の完全な履歴を含む[エージェントの実行結果](/openai-agents-js/ja/guides/results)オブジェクトを受け取ります。

## エージェントループ

Runner の run メソッドを使うとき、開始するエージェントと入力を渡します。入力は文字列（ユーザー メッセージとして扱われます）か、OpenAI Responses API のアイテムである入力アイテムのリストのいずれかです。

Runner は次のループを実行します:

1. 現在の入力で現在のエージェントのモデルを呼び出す
2. LLM 応答を確認する
   - **Final output** → 返す
   - **Handoff** → 新しいエージェントに切り替え、会話履歴を保持して 1 に戻る
   - **Tool calls** → ツールを実行し、その結果を会話に追加して 1 に戻る
3. `maxTurns` に達したら [`MaxTurnsExceededError`](/openai-agents-js/openai/agents-core/classes/maxturnsexceedederror) をスローする

<Aside type="note">
  LLM の出力が「final
  output」と見なされるルールは、望ましい型のテキスト出力を生成し、ツール呼び出しがない場合です。
</Aside>

### Runner ライフサイクル

アプリ起動時に `Runner` を作成し、リクエスト間で再利用します。インスタンスはモデルプロバイダーやトレーシング設定などのグローバル設定を保持します。完全に別のセットアップが必要な場合のみ別の `Runner` を作成します。簡単なスクリプトでは、内部でデフォルトの Runner を使う `run()` を呼び出すこともできます。

## 実行引数

`run()` メソッドへの入力は、実行を開始する初期エージェント、実行の入力、および一連のオプションです。

入力は、文字列（ユーザー メッセージとして扱われます）、[input items](/openai-agents-js/openai/agents-core/type-aliases/agentinputitem) のリスト、または [人間の介入（HITL）](/openai-agents-js/ja/guides/human-in-the-loop) エージェントを構築している場合の [`RunState`](/openai-agents-js/openai/agents-core/classes/runstate) オブジェクトのいずれかです。

追加オプションは次のとおりです:

| Option     | Default | Description                                                                                                                                   |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| `stream`   | `false` | `true` の場合、呼び出しは `StreamedRunResult` を返し、モデルから到着するイベントを逐次発行します                                              |
| `context`  | –       | すべての tool / guardrail / handoff に転送されるコンテキストオブジェクト。詳細は[コンテキスト管理](/openai-agents-js/ja/guides/context)を参照 |
| `maxTurns` | `10`    | セーフティリミット。到達時に [`MaxTurnsExceededError`](/openai-agents-js/openai/agents-core/classes/maxturnsexceedederror) をスロー           |
| `signal`   | –       | キャンセル用の `AbortSignal`                                                                                                                  |

## ストリーミング

ストリーミングにより、LLM の実行中にストリーミングイベントも受け取れます。ストリームが開始されると、`StreamedRunResult` は、新しく生成されたすべての出力を含め、実行に関する完全な情報を保持します。`for await` ループを使ってストリーミングイベントを反復処理できます。詳しくは[ストリーミング](/openai-agents-js/ja/guides/streaming)を参照してください。

## 実行設定

独自の `Runner` インスタンスを作成する場合は、Runner を構成するために `RunConfig` オブジェクトを渡すことができます。

| Field                       | Type                  | Purpose                                                                      |
| --------------------------- | --------------------- | ---------------------------------------------------------------------------- |
| `model`                     | `string \| Model`     | 実行中の**すべて**のエージェントに特定のモデルを強制します                   |
| `modelProvider`             | `ModelProvider`       | モデル名を解決します。デフォルトは OpenAI プロバイダーです                   |
| `modelSettings`             | `ModelSettings`       | エージェント個別設定を上書きするグローバルなチューニングパラメーター         |
| `handoffInputFilter`        | `HandoffInputFilter`  | handoff を実行する際に入力アイテムを変更します（handoff 自体で未定義の場合） |
| `inputGuardrails`           | `InputGuardrail[]`    | 最初のユーザー入力に適用されるガードレール                                   |
| `outputGuardrails`          | `OutputGuardrail[]`   | 最終出力に適用されるガードレール                                             |
| `tracingDisabled`           | `boolean`             | OpenAI トレーシングを完全に無効化します                                      |
| `traceIncludeSensitiveData` | `boolean`             | スパンは発行しつつ、トレースから LLM/ツールの入力・出力を除外します          |
| `workflowName`              | `string`              | Traces ダッシュボードに表示され、関連する実行をグループ化するのに役立ちます  |
| `traceId` / `groupId`       | `string`              | SDK に生成させず、トレース ID またはグループ ID を手動で指定します           |
| `traceMetadata`             | `Record<string, any>` | すべてのスパンに付与する任意のメタデータ                                     |

## 会話 / チャットスレッド

`runner.run()`（または `run()` ユーティリティ）への各呼び出しは、アプリケーションレベルの会話における 1 回の**ターン**を表します。エンドユーザーにどれだけの `RunResult` を見せるかは任意です。`finalOutput` のみの場合もあれば、生成されたすべてのアイテムを見せる場合もあります。

<Code lang="typescript" code={chatLoopExample} title="会話履歴を引き継ぐ例" />

対話的なバージョンは[チャットの例](https://github.com/openai/openai-agents-js/tree/main/examples/basic/chat.ts)を参照してください。

### サーバー管理の会話

毎ターンごとにローカルの全トランスクリプトを送信する代わりに、OpenAI Responses API に会話履歴を保持させることができます。長い会話や複数サービスの調整に便利です。詳細は[Conversation state guide](https://platform.openai.com/docs/guides/conversation-state?api-mode=responses)を参照してください。

OpenAI はサーバーサイド状態を再利用する 2 つの方法を提供します:

#### 1. 会話全体に対する `conversationId`

[Conversations API](https://platform.openai.com/docs/api-reference/conversations/create) を使って一度会話を作成し、その ID を各ターンで再利用できます。SDK は新しく生成されたアイテムのみを自動的に含めます。

<Code
  lang="typescript"
  code={conversationIdExample}
  title="サーバーの会話を再利用する"
/>

#### 2. 直前のターンから継続するための `previousResponseId`

最初から Responses API だけで始めたい場合は、前のレスポンスで返された ID を使って各リクエストを連結できます。会話リソースを作成せずに、ターン間でコンテキストを維持できます。

<Code
  lang="typescript"
  code={previousResponseIdExample}
  title="previousResponseId による連結"
/>

## 例外

SDK はキャッチ可能な少数のエラーをスローします:

- [`MaxTurnsExceededError`](/openai-agents-js/openai/agents-core/classes/maxturnsexceedederror) – `maxTurns` に到達
- [`ModelBehaviorError`](/openai-agents-js/openai/agents-core/classes/modelbehaviorerror) – モデルが無効な出力を生成（例: 不正な JSON、未知のツール）
- [`InputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents-core/classes/inputguardrailtripwiretriggered) / [`OutputGuardrailTripwireTriggered`](/openai-agents-js/openai/agents-core/classes/outputguardrailtripwiretriggered) – ガードレール違反
- [`GuardrailExecutionError`](/openai-agents-js/openai/agents-core/classes/guardrailexecutionerror) – ガードレールの実行に失敗
- [`ToolCallError`](/openai-agents-js/openai/agents-core/classes/toolcallerror) – 関数ツールの呼び出しに失敗
- [`UserError`](/openai-agents-js/openai/agents-core/classes/usererror) – 設定またはユーザー入力に基づいてスローされたエラー

これらはすべて基底の `AgentsError` クラスを拡張しており、現在の実行状態にアクセスするための `state` プロパティを提供する場合があります。

以下は `GuardrailExecutionError` を処理するコード例です。入力ガードレールは最初のユーザー入力でのみ実行されるため、この例では元の入力とコンテキストで実行を再開します。また、保存した状態を再利用して、モデルを再呼び出しせずに出力ガードレールを再試行する方法も示しています:

<Code
  lang="typescript"
  code={runningAgentsExceptionExample}
  title="ガードレール実行エラー"
/>

入力と出力のリトライ:

- 入力ガードレールは実行の最初のユーザー入力でのみ実行されるため、同じ入力/コンテキストで新しい実行を開始して再試行する必要があります。保存した `state` を渡しても入力ガードレールは再実行されません
- 出力ガードレールはモデル応答の後に実行されるため、`GuardrailExecutionError` から保存した `state` を再利用して、モデルを再度呼び出さずに出力ガードレールを再実行できます

上記の例を実行すると、次の出力が表示されます:

```
Guardrail execution failed (input): Error: Input guardrail failed to complete: Error: Something is wrong!
Math homework input guardrail tripped on retry
Guardrail execution failed (output): Error: Output guardrail failed to complete: Error: Output guardrail crashed.
Output guardrail tripped after retry with saved state
```

---

## 次のステップ

- [モデル](/openai-agents-js/ja/guides/models)の設定方法を学ぶ
- エージェントに[ツール](/openai-agents-js/ja/guides/tools)を提供する
- 本番運用に向けて[ガードレール](/openai-agents-js/ja/guides/guardrails)や[トレーシング](/openai-agents-js/ja/guides/tracing)を追加する
