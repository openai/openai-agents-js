---
title: 追踪
description: Learn how to trace your agent runs
---

import { Aside, Code } from '@astrojs/starlight/components';
import customTraceExample from '../../../../../../examples/docs/custom-trace.ts?raw';
import cloudflareWorkers from '../../../../../../examples/docs/tracing/cloudflareWorkers.ts?raw';

Agents SDK 内置了追踪功能，可在智能体运行期间收集全面的事件记录：LLM 生成、工具调用、交接、护栏，甚至自定义事件。通过 [Traces 仪表板](https://platform.openai.com/traces)，您可以在开发与生产环境中调试、可视化并监控工作流。

<Aside type="note">

追踪默认启用。可以通过两种方式禁用追踪：

1. 通过设置环境变量 `OPENAI_AGENTS_DISABLE_TRACING=1` 可全局禁用追踪
2. 通过将 [`RunConfig.tracingDisabled`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#tracingdisabled) 设为 `true`，可仅对单次运行禁用追踪

**_对于在使用 OpenAI 的 API 时遵循 Zero Data Retention (ZDR) 政策的组织，追踪不可用。_**

</Aside>

## 导出循环生命周期

在大多数环境中，追踪会按固定间隔自动导出。在浏览器或 Cloudflare Workers 中，此功能默认禁用。当排队的追踪过多时仍会触发导出，但不会按固定间隔导出。相应地，您应使用 `getGlobalTraceProvider().forceFlush()` 将导出作为代码生命周期的一部分手动执行。

例如，在 Cloudflare Worker 中，应将代码包装在 `try/catch/finally` 块里，并结合 `waitUntil` 调用强制刷新，以确保在 worker 退出前导出追踪。

<Code
  lang="typescript"
  code={cloudflareWorkers.replace(/\s+\/\/ @ts-expect-error.*$/m, '')}
  meta="{13}"
/>

## 追踪与跨度

- **追踪（Traces）** 表示一次“工作流”的端到端操作。它由多个跨度（Spans）组成。追踪具有以下属性：
  - `workflow_name`：逻辑上的工作流或应用名称。例如 “代码生成” 或 “客户服务”。
  - `trace_id`：追踪的唯一 ID。如果未传入会自动生成。必须匹配格式 `trace_<32_alphanumeric>`。
  - `group_id`：可选的分组 ID，用于关联来自同一会话的多个追踪。例如可使用聊天线程 ID。
  - `disabled`：若为 True，则不会记录该追踪。
  - `metadata`：追踪的可选元数据。
- **跨度（Spans）** 表示具有开始与结束时间的操作。跨度包含：
  - `started_at` 与 `ended_at` 时间戳
  - `trace_id`，表示其所属的追踪
  - `parent_id`，指向其父跨度（如有）
  - `span_data`，即关于该跨度的信息。例如，`AgentSpanData` 包含关于智能体的信息，`GenerationSpanData` 包含关于 LLM 生成的信息，等等。

## 默认追踪

默认情况下，SDK 会追踪以下内容：

- 整个 `run()` 或 `Runner.run()` 被封装在一个 `Trace` 中
- 每次智能体运行，都会被封装在 `AgentSpan` 中
- LLM 的生成被封装在 `GenerationSpan` 中
- 每次函数工具调用都会被封装在 `FunctionSpan` 中
- 护栏被封装在 `GuardrailSpan` 中
- 交接被封装在 `HandoffSpan` 中

默认情况下，trace 被命名为 "Agent workflow"。如果使用 `withTrace`，您可以设置该名称；或者通过 [`RunConfig.workflowName`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#workflowname) 配置名称及其他属性。

此外，您可以设置[自定义追踪处理器](#custom-tracing-processors)，将追踪推送到其他目标（作为替代或附加目的地）。

### 语音智能体追踪

如果您在默认的 OpenAI Realtime API 下使用 `RealtimeAgent` 与 `RealtimeSession`，追踪将自动在 Realtime API 侧进行，除非您在 `RealtimeSession` 上通过 `tracingDisabled: true` 禁用，或通过 `OPENAI_AGENTS_DISABLE_TRACING` 环境变量禁用。

请参阅 [Overview](/openai-agents-js/zh/guides/voice-agents) 了解更多详情。

## 更高层级的追踪

有时，您可能希望多次调用 `run()` 属于同一个追踪。可将整段代码包裹在 `withTrace()` 中来实现。

<Code lang="typescript" code={customTraceExample} />

1. 由于两次 `run` 调用都包裹在 `withTrace()` 中，这两次独立运行会属于同一个整体追踪，而不是创建两个追踪。

## 创建追踪

您可以使用 [`withTrace()`](/openai-agents-js/openai/agents-core/functions/withtrace/) 函数来创建追踪。或者，您也可以使用 `getGlobalTraceProvider().createTrace()` 手动创建一个新追踪，并将其传入 `withTrace()`。

当前追踪通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或相应环境的 polyfill 来追踪。这意味着它可自动适配并发场景。

## 创建跨度

您可以使用各类 `create*Span()` 方法（如 `createGenerationSpan()`、`createFunctionSpan()` 等）来创建跨度。一般来说，无需手动创建跨度。可使用 [`createCustomSpan()`](/openai-agents-js/openai/agents-core/functions/createcustomspan/) 记录自定义跨度信息。

跨度会自动归属到当前追踪，并嵌套在最近的当前跨度之下；当前跨度通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或相应环境的 polyfill 来追踪。

## 敏感数据

某些跨度可能会捕获潜在的敏感数据。

`createGenerationSpan()` 会存储 LLM 生成的输入/输出，`createFunctionSpan()` 会存储函数调用的输入/输出。这些可能包含敏感数据，因此您可以通过 [`RunConfig.traceIncludeSensitiveData
`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#traceincludesensitivedata) 禁用对这些数据的捕获。

## 自定义追踪处理器

追踪的高层架构如下：

- 在初始化时，我们会创建全局 [`TraceProvider`](/openai-agents-js/openai/agents-core/classes/traceprovider)，负责创建追踪，并可通过 [`getGlobalTraceProvider()`](/openai-agents-js/openai/agents-core/functions/getglobaltraceprovider/) 访问。
- 我们为 `TraceProvider` 配置一个 [`BatchTraceProcessor`](/openai-agents-js/openai/agents-core/classes/batchtraceprocessor/)，它会将追踪/跨度成批发送给 [`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter/)，由其将跨度与追踪成批导出到 OpenAI 后端。

若要自定义该默认配置，将追踪发送到替代或附加的后端，或修改导出器行为，您有两种选择：

1. [`addTraceProcessor()`](/openai-agents-js/openai/agents-core/functions/addtraceprocessor) 允许添加**额外**的追踪处理器，该处理器会在追踪与跨度就绪时接收它们。这样除了将追踪发送至 OpenAI 后端外，您还可执行自定义处理。
2. [`setTraceProcessors()`](/openai-agents-js/openai/agents-core/functions/settraceprocessors) 允许**替换**默认处理器为您自己的追踪处理器。这意味着除非包含一个会将数据发送到 OpenAI 后端的 `TracingProcessor`，否则追踪将不会发送到 OpenAI 后端。

## 外部追踪处理器列表

- [AgentOps](https://docs.agentops.ai/v2/usage/typescript-sdk#openai-agents-integration)
- [Keywords AI](https://docs.keywordsai.co/integration/development-frameworks/openai-agents-sdk-js)
