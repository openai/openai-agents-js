---
title: 模型上下文协议 (MCP)
description: Learn how to utilize MCP servers as tools
---

import { Code } from '@astrojs/starlight/components';
import hostedAgentExample from '../../../../../../examples/docs/mcp/hostedAgent.ts?raw';
import hostedExample from '../../../../../../examples/docs/mcp/hosted.ts?raw';
import hostedStreamExample from '../../../../../../examples/docs/mcp/hostedStream.ts?raw';
import hostedHITLExample from '../../../../../../examples/docs/mcp/hostedHITL.ts?raw';
import hostedConnectorExample from '../../../../../../examples/docs/mcp/hostedConnector.ts?raw';
import streamableHttpExample from '../../../../../../examples/docs/mcp/streamableHttp.ts?raw';
import stdioExample from '../../../../../../examples/docs/mcp/stdio.ts?raw';
import toolFilterExample from '../../../../../../examples/docs/mcp/tool-filter.ts?raw';

[**Model Context Protocol (MCP)**](https://modelcontextprotocol.io) 是一个开放协议，用于规范应用如何向 LLM 提供工具和上下文。摘自 MCP 文档：

> MCP 是一个开放协议，用于规范应用如何向 LLM 提供上下文。可以把 MCP 想象成 AI 应用的 USB‑C 接口。正如 USB‑C 为设备连接各类外设与配件提供了统一方式，MCP 为连接 AI 模型与不同数据源和工具提供了统一方式。

该 SDK 支持三种类型的 MCP 服务器：

1. **远程 MCP 服务器工具** – 由 [OpenAI Responses API](https://platform.openai.com/docs/guides/tools-remote-mcp) 作为工具调用的远程 MCP 服务器
2. **Streamable HTTP MCP 服务器** – 实现了 [Streamable HTTP 传输](https://modelcontextprotocol.io/docs/concepts/transports#streamable-http) 的本地或远程服务器
3. **Stdio MCP 服务器** – 通过标准输入/输出访问的服务器（最简单的选项）

请根据你的用例选择服务器类型：

| 你的需求                                                        | 推荐选项                   |
| --------------------------------------------------------------- | -------------------------- |
| 使用默认的 OpenAI Responses 模型调用公共可访问的远程服务器      | **1. 远程 MCP 服务器工具** |
| 使用公共可访问的远程服务器，但在本地触发工具调用                | **2. Streamable HTTP**     |
| 使用本地运行的 Streamable HTTP 服务器                           | **2. Streamable HTTP**     |
| 将非 OpenAI Responses 模型与任意 Streamable HTTP 服务器配合使用 | **2. Streamable HTTP**     |
| 使用只支持标准 I/O 协议的本地 MCP 服务器                        | **3. Stdio**               |

## 1. 远程 MCP 服务器工具

托管工具会将整个往返交互推送到模型中。不是你的代码调用 MCP 服务器，而是由 OpenAI Responses API 调用远程工具端点，并将结果流式传回模型。

下面是使用托管 MCP 工具的最简单示例。你可以将远程 MCP 服务器的标签和 URL 传给 `hostedMcpTool` 实用函数，便于创建托管 MCP 服务器工具。

<Code lang="typescript" code={hostedAgentExample} title="hostedAgent.ts" />

然后，你可以使用 `run` 函数（或你自定义的 `Runner` 实例的 `run` 方法）来运行智能体：

<Code
  lang="typescript"
  code={hostedExample}
  title="使用远程 MCP 服务器工具运行"
/>

若要流式获取增量 MCP 结果，在运行 `Agent` 时传入 `stream: true`：

<Code
  lang="typescript"
  code={hostedStreamExample}
  title="使用远程 MCP 服务器工具运行（流式传输）"
/>

#### 可选审批流程

对于敏感操作，你可以要求对每次工具调用进行人工审批。传入 `requireApproval: 'always'`，或传入一个细粒度对象，将工具名称映射为 `'never'`/`'always'`。

如果你能以编程方式判断工具调用是否安全，可以使用 [`onApproval` 回调](https://github.com/openai/openai-agents-js/blob/main/examples/mcp/hosted-mcp-on-approval.ts) 来批准或拒绝工具调用。如果需要人工审批，你可以使用与本地函数工具相同的、基于 `interruptions` 的 [Human-in-the-loop](/openai-agents-js/zh/guides/human-in-the-loop/) 方法。

<Code
  lang="typescript"
  code={hostedHITLExample}
  title="结合远程 MCP 服务器工具的人工干预"
/>

### 由连接器支持的托管服务器

托管 MCP 也支持 OpenAI 连接器。你无需提供 `serverUrl`，而是传入连接器的 `connectorId` 和 `authorization` 令牌。Responses API 将处理身份验证，并通过托管 MCP 接口暴露连接器的工具。

<Code
  lang="typescript"
  code={hostedConnectorExample}
  title="由连接器支持的托管 MCP 工具"
/>

在此示例中，环境变量 `GOOGLE_CALENDAR_AUTHORIZATION` 存放了从 Google OAuth Playground 获取的 OAuth 令牌，它授权由连接器支持的服务器调用 Calendar API。包含可运行示例并演示流式传输的样例见 [`examples/connectors`](https://github.com/openai/openai-agents-js/tree/main/examples/connectors)。

在我们的 GitHub 仓库中可以找到完整可运行的示例（托管工具/Streamable HTTP/stdio + 流式传输、HITL、onApproval）：[examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp)。

## 2. Streamable HTTP MCP 服务器

当你的智能体直接与本地或远程的 Streamable HTTP MCP 服务器通信时，可用服务器的 `url`、`name` 和可选设置实例化 `MCPServerStreamableHttp`：

<Code
  lang="typescript"
  code={streamableHttpExample}
  title="使用 Streamable HTTP MCP 服务器运行"
/>

该构造函数还接受其他 MCP TypeScript SDK 选项，如 `authProvider`、`requestInit`、`fetch`、`reconnectionOptions` 和 `sessionId`。详见 [MCP TypeScript SDK 仓库](https://github.com/modelcontextprotocol/typescript-sdk)及其文档。

## 3. Stdio MCP 服务器

对于仅通过标准 I/O 暴露的服务器，使用 `fullCommand` 实例化 `MCPServerStdio`：

<Code lang="typescript" code={stdioExample} title="使用 Stdio MCP 服务器运行" />

## 其他注意事项

对于 **Streamable HTTP** 和 **Stdio** 服务器，每次运行 `Agent` 时，它都可能调用 `list_tools()` 来发现可用工具。由于这次往返会带来延迟（尤其是访问远程服务器时），你可以通过向 `MCPServerStdio` 或 `MCPServerStreamableHttp` 传入 `cacheToolsList: true` 来在内存中缓存结果。

只有在你确信工具列表不会变化时才启用此功能。若需稍后使缓存失效，可在服务器实例上调用 `invalidateToolsCache()`。

### 工具筛选

你可以通过传入静态筛选器（`createMCPToolStaticFilter`）或自定义函数，限制每个服务器对外暴露的工具。下面是一个组合示例，展示了两种方式：

<Code lang="typescript" code={toolFilterExample} title="工具筛选" />

## 延伸阅读

- [Model Context Protocol](https://modelcontextprotocol.io/) – 官方规范。
- [examples/mcp](https://github.com/openai/openai-agents-js/tree/main/examples/mcp) – 可运行的
  演示（上文引用）。
