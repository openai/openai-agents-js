name: Changeset

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

jobs:
  changeset-validation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.28.0
          run_install: false
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Generate changeset prompt
        run: |
          pnpm changeset:validate -- \
            --ci \
            --output .github/codex/prompts/changeset-validation.generated.md \
            --base ${{ github.event.pull_request.base.sha }} \
            --head ${{ github.event.pull_request.head.sha }}

      - name: Prepare Codex output dir
        run: mkdir -p .github/codex/outputs

      - name: Run Codex changeset validation
        id: run_codex
        if: ${{ !github.event.pull_request.head.repo.fork && github.actor != 'dependabot[bot]' }}
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.PROD_OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/changeset-validation.generated.md
          output-file: .github/codex/outputs/changeset-validation.json
          output-schema-file: .github/codex/schemas/changeset-validation.json
          codex-args: '["--full-auto"]'
          sandbox: read-only
          safety-strategy: drop-sudo

      - name: Validate Codex output
        if: ${{ steps.run_codex.conclusion == 'success' }}
        run: pnpm changeset:validate-result -- .github/codex/outputs/changeset-validation.json

      - name: Assign milestone
        if: ${{ steps.run_codex.conclusion == 'success' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm changeset:assign-milestone -- .github/codex/outputs/changeset-validation.json
