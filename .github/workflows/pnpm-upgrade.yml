name: pnpm upgrade

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pnpm-upgrade
  cancel-in-progress: false

jobs:
  pnpm-upgrade:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        with:
          version: 10.28.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Enable Corepack
        run: corepack enable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run pnpm-upgrade skill
        id: codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189
        with:
          openai-api-key: ${{ secrets.PROD_OPENAI_API_KEY }}
          prompt-file: .github/codex/prompts/pnpm-upgrade.md
          sandbox: danger-full-access
          safety-strategy: drop-sudo
          codex-args: --full-auto

      - name: Create pull request
        if: ${{ success() }}
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: upgrade pnpm toolchain"
          branch: automation/pnpm-upgrade
          title: "chore: upgrade pnpm toolchain"
          body: |
            Automated pnpm upgrade run.

            - updates pnpm via pnpm self-update and aligns packageManager
            - bumps pnpm/action-setup pins in workflows
            - opened by scheduled Codex run if changes exist
          labels: automation,pnpm
          signoff: true
          draft: false
